<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Video Call (Firebase RTDB + TURN)</title>
  <style>
    video {
      width: 45%;
      margin: 10px;
      border: 2px solid #333;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>WebRTC Video Call (Firebase RTDB + STUN/TURN)</h2>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <br>
  <button id="createBtn">Create Call</button>
  <input id="callId" placeholder="Enter Call ID">
  <button id="answerBtn">Answer Call</button>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqusbmSr_8EOCwT6KjVUTabqowsdxi08Q",
      authDomain: "video-a15df.firebaseapp.com",
      databaseURL: "https://video-a15df-default-rtdb.firebaseio.com",
      projectId: "video-a15df",
      storageBucket: "video-a15df.firebasestorage.app",
      messagingSenderId: "806053569189",
      appId: "1:806053569189:web:e9a445a85571f7c546634c",
      measurementId: "G-N8M15S88XL"
    };

    // ✅ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ✅ Use STUN + TURN (Metered free relay)
    const servers = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: [
            "turn:openrelay.metered.ca:80",
            "turn:openrelay.metered.ca:443",
            "turn:openrelay.metered.ca:443?transport=tcp"
          ],
          username: "openrelayproject",
          credential: "openrelayproject"
        }
      ]
    };

    const pc = new RTCPeerConnection(servers);

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    let localStream, remoteStream;

    // ✅ Media setup
    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      remoteStream = new MediaStream();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));

      localVideo.srcObject = localStream;
      remoteVideo.srcObject = remoteStream;
    }
    initMedia();

    // ✅ Create Call
    document.getElementById("createBtn").onclick = async () => {
      const callId = db.ref("calls").push().key;
      document.getElementById("callId").value = callId;

      const callRef = db.ref("calls/" + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("offerCandidates").push(event.candidate.toJSON());
        }
      };

      const offerDescription = await pc.createOffer();
      await pc.setLocalDescription(offerDescription);

      await callRef.child("offer").set({
        type: offerDescription.type,
        sdp: offerDescription.sdp
      });

      callRef.child("answer").on("value", snapshot => {
        const data = snapshot.val();
        if (data && !pc.currentRemoteDescription) {
          pc.setRemoteDescription(new RTCSessionDescription(data));
        }
      });

      callRef.child("answerCandidates").on("child_added", snapshot => {
        const data = snapshot.val();
        if (data) pc.addIceCandidate(new RTCIceCandidate(data));
      });
    };

    // ✅ Answer Call
    document.getElementById("answerBtn").onclick = async () => {
      const callId = document.getElementById("callId").value;
      const callRef = db.ref("calls/" + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("answerCandidates").push(event.candidate.toJSON());
        }
      };

      const offerSnapshot = await callRef.child("offer").get();
      const offerDescription = offerSnapshot.val();

      await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      await callRef.child("answer").set({
        type: answerDescription.type,
        sdp: answerDescription.sdp
      });

      callRef.child("offerCandidates").on("child_added", snapshot => {
        const data = snapshot.val();
        if (data) pc.addIceCandidate(new RTCIceCandidate(data));
      });
    };
  </script>
</body>
</html>
