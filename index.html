<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Video Call (Firebase RTDB)</title>
  <style>
    video {
      width: 45%;
      margin: 10px;
      border: 2px solid #333;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2>WebRTC Video Call (Firebase RTDB Signaling)</h2>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <br>
  <button id="createBtn">Create Call</button>
  <input id="callId" placeholder="Enter Call ID">
  <button id="answerBtn">Answer Call</button>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAlKJEz_F0bfuPvuyFqwRxmvpzqInzc66c",
      authDomain: "fir-project-cc625.firebaseapp.com",
      databaseURL: "https://fir-project-cc625-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fir-project-cc625",
      storageBucket: "fir-project-cc625.firebasestorage.app",
      messagingSenderId: "638635005703",
      appId: "1:638635005703:web:3433da7c8c6627447797a2",
      measurementId: "G-9QEPJMF6CX"
    };

    // ✅ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const servers = { iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] };
    const pc = new RTCPeerConnection(servers);

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    let localStream, remoteStream;

    // ✅ Media setup
    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      remoteStream = new MediaStream();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));

      localVideo.srcObject = localStream;
      remoteVideo.srcObject = remoteStream;
    }
    initMedia();

    // ✅ Create Call
    document.getElementById("createBtn").onclick = async () => {
      const callId = db.ref("calls").push().key;
      document.getElementById("callId").value = callId;

      const callRef = db.ref("calls/" + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("offerCandidates").push(event.candidate.toJSON());
        }
      };

      const offerDescription = await pc.createOffer();
      await pc.setLocalDescription(offerDescription);

      await callRef.child("offer").set({
        type: offerDescription.type,
        sdp: offerDescription.sdp
      });

      callRef.child("answer").on("value", snapshot => {
        const data = snapshot.val();
        if (data && !pc.currentRemoteDescription) {
          pc.setRemoteDescription(new RTCSessionDescription(data));
        }
      });

      callRef.child("answerCandidates").on("child_added", snapshot => {
        const data = snapshot.val();
        if (data) pc.addIceCandidate(new RTCIceCandidate(data));
      });
    };

    // ✅ Answer Call
    document.getElementById("answerBtn").onclick = async () => {
      const callId = document.getElementById("callId").value;
      const callRef = db.ref("calls/" + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("answerCandidates").push(event.candidate.toJSON());
        }
      };

      const offerSnapshot = await callRef.child("offer").get();
      const offerDescription = offerSnapshot.val();

      await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      await callRef.child("answer").set({
        type: answerDescription.type,
        sdp: answerDescription.sdp
      });

      callRef.child("offerCandidates").on("child_added", snapshot => {
        const data = snapshot.val();
        if (data) pc.addIceCandidate(new RTCIceCandidate(data));
      });
    };
  </script>
</body>
</html>
