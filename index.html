<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebRTC Chat with Custom or Random Call ID</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f9f9f9; }
    #videos { display: flex; justify-content: center; margin: 10px; }
    video { width: 300px; margin: 5px; border: 2px solid #333; border-radius: 10px; background: black; }
    #controls { margin: 10px; }
    #chatBox { 
      width: 400px; height: 200px; border: 1px solid #ccc; 
      overflow-y: auto; margin: 10px auto; padding: 10px; background: #fff; text-align: left;
    }
    .me { color: green; margin: 5px 0; text-align: right; }
    .other { color: blue; margin: 5px 0; text-align: left; }
    #chatInput { width: 300px; padding: 5px; }
  </style>
</head>
<body>
  <h2>WebRTC Video Chat</h2>
  <div id="videos">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div id="controls">
    <input type="text" id="callId" placeholder="Enter Call ID (or leave blank)">
    <button id="createBtn">Create Call</button>
    <button id="answerBtn">Answer Call</button>
  </div>

  <div id="chatBox"></div>
  <input type="text" id="chatInput" placeholder="Type a message">
  <button id="sendBtn">Send</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAqusbmSr_8EOCwT6KjVUTabqowsdxi08Q",
      authDomain: "video-a15df.firebaseapp.com",
      databaseURL: "https://video-a15df-default-rtdb.firebaseio.com",
      projectId: "video-a15df",
      storageBucket: "video-a15df.firebasestorage.app",
      messagingSenderId: "806053569189",
      appId: "1:806053569189:web:e9a445a85571f7c546634c",
      measurementId: "G-N8M15S88XL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    let localStream, remoteStream, currentCallRef, role = null;

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;
    }
    initMedia();

    function setupPC(pc, callRef) {
      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("candidates").push(JSON.stringify(event.candidate));
        }
      };
      pc.ontrack = event => event.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
    }

    // ✅ Chat system
    function initChat() {
      const chatBox = document.getElementById("chatBox");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");

      currentCallRef.child("chat").on("child_added", snapshot => {
        const msgData = snapshot.val();
        const div = document.createElement("div");
        if (msgData.role === role) {
          div.textContent = msgData.text;
          div.className = "me";
        } else {
          div.textContent = msgData.text;
          div.className = "other";
        }
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      sendBtn.onclick = () => {
        const msg = chatInput.value.trim();
        if (msg) {
          currentCallRef.child("chat").push({ role: role, text: msg });
          chatInput.value = "";
        }
      };

      chatInput.addEventListener("keypress", e => {
        if (e.key === "Enter") sendBtn.click();
      });
    }

    // ✅ Create Call
    document.getElementById("createBtn").onclick = async () => {
      role = "me";

      let callIdInput = document.getElementById("callId").value.trim();
      let callRef;

      if (callIdInput) {
        // custom key
        callRef = db.ref("calls/" + callIdInput);
      } else {
        // auto generated key
        callRef = db.ref("calls").push();
        document.getElementById("callId").value = callRef.key;
      }

      currentCallRef = callRef;

      const pc = new RTCPeerConnection(config);
      setupPC(pc, callRef);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await callRef.child("offer").set(JSON.stringify(offer));

      callRef.child("answer").on("value", async snap => {
        if (snap.val() && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(snap.val())));
        }
      });

      callRef.child("candidates").on("child_added", async snap => {
        const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
        try { await pc.addIceCandidate(candidate); } catch (e) {}
      });

      initChat();
    };

    // ✅ Answer Call
    document.getElementById("answerBtn").onclick = async () => {
      role = "other";
      const callId = document.getElementById("callId").value.trim();
      if (!callId) return alert("Enter Call ID to answer");

      const callRef = db.ref("calls/" + callId);
      currentCallRef = callRef;

      const pc = new RTCPeerConnection(config);
      setupPC(pc, callRef);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      const offerSnap = await callRef.child("offer").once("value");
      if (offerSnap.val()) {
        await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(offerSnap.val())));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await callRef.child("answer").set(JSON.stringify(answer));
      }

      callRef.child("candidates").on("child_added", async snap => {
        const candidate = new RTCIceCandidate(JSON.parse(snap.val()));
        try { await pc.addIceCandidate(candidate); } catch (e) {}
      });

      initChat();
    };
  </script>
</body>
</html>
