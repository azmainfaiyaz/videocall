<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Video Call + Chat (Firebase RTDB)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 45%;
      margin: 10px;
      border: 2px solid #333;
      border-radius: 10px;
      background: black;
    }
    #chatBox {
      width: 90%;
      height: 200px;
      border: 1px solid #333;
      border-radius: 8px;
      overflow-y: auto;
      padding: 8px;
      margin: 15px auto;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    #chatBox div {
      margin: 5px 0;
      padding: 6px 10px;
      border-radius: 6px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .A {
      background: #d1ffd1; /* Greenish */
      align-self: flex-end;
    }
    .B {
      background: #d1e0ff; /* Bluish */
      align-self: flex-start;
    }
    #chatInput {
      width: 70%;
      padding: 8px;
      margin-right: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #sendBtn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: white;
      cursor: pointer;
    }
    #sendBtn:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h2>WebRTC Video Call + Chat (Firebase RTDB + STUN/TURN)</h2>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <br>
  <button id="createBtn">Create Call</button>
  <input id="callId" placeholder="Enter Call ID">
  <button id="answerBtn">Answer Call</button>

  <h3>Chat</h3>
  <div id="chatBox"></div>
  <input id="chatInput" placeholder="Type a message...">
  <button id="sendBtn">Send</button>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ✅ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAqusbmSr_8EOCwT6KjVUTabqowsdxi08Q",
      authDomain: "video-a15df.firebaseapp.com",
      databaseURL: "https://video-a15df-default-rtdb.firebaseio.com",
      projectId: "video-a15df",
      storageBucket: "video-a15df.firebasestorage.app",
      messagingSenderId: "806053569189",
      appId: "1:806053569189:web:e9a445a85571f7c546634c",
      measurementId: "G-N8M15S88XL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ✅ STUN/TURN
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: "stun:stun.relay.metered.ca:80" },
        {
          urls: "turn:global.relay.metered.ca:80",
          username: "ffa604f96ab2ed1a058c3d67",
          credential: "NnV8tipDjdKKg+Sz",
        },
        {
          urls: "turn:global.relay.metered.ca:80?transport=tcp",
          username: "ffa604f96ab2ed1a058c3d67",
          credential: "NnV8tipDjdKKg+Sz",
        },
        {
          urls: "turn:global.relay.metered.ca:443",
          username: "ffa604f96ab2ed1a058c3d67",
          credential: "NnV8tipDjdKKg+Sz",
        },
        {
          urls: "turns:global.relay.metered.ca:443?transport=tcp",
          username: "ffa604f96ab2ed1a058c3d67",
          credential: "NnV8tipDjdKKg+Sz",
        },
      ]
    });

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    let localStream, remoteStream;
    let currentCallRef = null;
    let myRole = null; // "A" or "B"

    // ✅ Media setup
    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      remoteStream = new MediaStream();

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = event => event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));

      localVideo.srcObject = localStream;
      remoteVideo.srcObject = remoteStream;
    }
    initMedia();

    // ✅ Create Call (User A)
    document.getElementById("createBtn").onclick = async () => {
      const callId = db.ref("calls").push().key;
      document.getElementById("callId").value = callId;
      currentCallRef = db.ref("calls/" + callId);
      myRole = "A";

      pc.onicecandidate = event => {
        if (event.candidate) {
          currentCallRef.child("offerCandidates").push(event.candidate.toJSON());
        }
      };

      const offerDescription = await pc.createOffer();
      await pc.setLocalDescription(offerDescription);

      await currentCallRef.child("offer").set({
        type: offerDescription.type,
        sdp: offerDescription.sdp
      });

      currentCallRef.child("answer").on("value", snapshot => {
        const data = snapshot.val();
        if (data && !pc.currentRemoteDescription) {
          pc.setRemoteDescription(new RTCSessionDescription(data));
        }
      });

      currentCallRef.child("answerCandidates").on("child_added", snapshot => {
        const data = snapshot.val();
        if (data) pc.addIceCandidate(new RTCIceCandidate(data));
      });

      initChat();
    };

    // ✅ Answer Call (User B)
    document.getElementById("answerBtn").onclick = async () => {
      const callId = document.getElementById("callId").value;
      currentCallRef = db.ref("calls/" + callId);
      myRole = "B";

      pc.onicecandidate = event => {
        if (event.candidate) {
          currentCallRef.child("answerCandidates").push(event.candidate.toJSON());
        }
      };

      const offerSnapshot = await currentCallRef.child("offer").get();
      const offerDescription = offerSnapshot.val();

      await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

      const answerDescription = await pc.createAnswer();
      await pc.setLocalDescription(answerDescription);

      await currentCallRef.child("answer").set({
        type: answerDescription.type,
        sdp: answerDescription.sdp
      });

      currentCallRef.child("offerCandidates").on("child_added", snapshot => {
        const data = snapshot.val();
        if (data) pc.addIceCandidate(new RTCIceCandidate(data));
      });

      initChat();
    };

    // ✅ Chat Logic
    function initChat() {
      const chatBox = document.getElementById("chatBox");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");

      // Listen for new messages
      currentCallRef.child("chat").on("child_added", snapshot => {
        const msg = snapshot.val();
        const div = document.createElement("div");
        div.textContent = msg.text;
        div.className = msg.sender;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

      // Send message
      sendBtn.onclick = () => {
        const msg = chatInput.value.trim();
        if (msg) {
          currentCallRef.child("chat").push({
            sender: myRole,
            text: msg
          });
          chatInput.value = "";
        }
      };

      // Send on Enter key
      chatInput.addEventListener("keypress", e => {
        if (e.key === "Enter") sendBtn.click();
      });
    }
  </script>
</body>
</html>
